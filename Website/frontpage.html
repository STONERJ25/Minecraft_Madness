<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiCam Server</title>
    <link rel="stylesheet" href="frontpage.css" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="./aboutRobot.html">About the Robot</a></li>
                <li><a href="./aboutTeam.html">About the Team</a></li>
                <li><a href="./about.html">More Information</a></li>
            </ul>
        </nav>
        
    </header>
    <img src="images/MinecraftLogo.webp" alt="MMLogo" style="width: 150px;">

    <main>
        <h1>Minecraft Madness Live Streaming</h1>

        <!-- Imported Video Stream Preview -->
        <h2>Imported Video Stream Preview</h2>
        <div id="container">
            <img id="imageElement" style="width: 100%; max-width: 800px;">
        </div>

        <button type="button" onclick="takeScreenshot()">Screenshot</button>
        <canvas id="canvas" style="display:none;"></canvas>

        <div id="screenshotGallery">
            <h2>Screenshot Gallery</h2>
            <div id="galleryContainer"></div>
        </div>
    </main>

    <footer>Pixelforge Games All rights reserved &#169;</footer>

    <script>
        const image = document.querySelector("#imageElement");

        // WebSocket connection to the server
        const socket = new WebSocket('ws://localhost:8765');

        socket.binaryType = 'arraybuffer';  // Receive data as binary

        let lastFrameTime = 0;
        const FRAME_RATE_LIMIT = 1000 / 30;  // Limit to 30 frames per second

     // In your JavaScript

socket.onmessage = function(event) {
    const frameData = event.data;  // Already in binary format as ArrayBuffer

    // Check frame rate
    const currentTime = Date.now();
    if (currentTime - lastFrameTime > FRAME_RATE_LIMIT) {
        // Create a Blob from the ArrayBuffer
        const imageBlob = new Blob([frameData], { type: 'image/jpeg' });

        // Create an object URL for the image Blob
        const imageURL = URL.createObjectURL(imageBlob);

        // Set the image element's source to the Blob URL
        image.src = imageURL;

        // Update last frame time
        lastFrameTime = currentTime;

        // Optional: Revoke the object URL after a short delay to free up memory
        setTimeout(() => URL.revokeObjectURL(imageURL), 100);
    }
};


        // Screenshot functionality
        function takeScreenshot() {
            let canvas = document.getElementById("canvas");
            let img = document.getElementById("imageElement");
            
            // Set canvas dimensions to match image dimensions
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            
            // Draw image frame to canvas
            let context = canvas.getContext("2d");
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas image to data URL
            let imgData = canvas.toDataURL("image/jpeg");
        
            // Create a new image element for the gallery
            let galleryImg = document.createElement("img");
            galleryImg.src = imgData;
            galleryImg.style.width = "150px";  // Set thumbnail size
            galleryImg.style.margin = "5px";   // Add some space around each thumbnail
        
            // Append the image to the gallery container
            document.getElementById("galleryContainer").appendChild(galleryImg);
        
            // Optionally, download the image
            let link = document.createElement('a');
            link.href = imgData;
            link.download = 'screenshot.jpg';
            link.click();
        }
    </script>
</body>
</html>
